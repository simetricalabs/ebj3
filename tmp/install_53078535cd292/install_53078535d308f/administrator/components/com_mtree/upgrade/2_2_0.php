<?php
/**
 * @package		Mosets Tree
 * @copyright		(C) 2011 Mosets Consulting. All rights reserved.
 * @license		GNU General Public License
 * @author		Lee Cher Yeong <mtree@mosets.com>
 * @url			http://www.mosets.com/tree/
 */

defined('_JEXEC') or die('Restricted access');

class mUpgrade_2_2_0 extends mUpgrade {
	function upgrade() {
		$database =& JFactory::getDBO();
		
		$database->setQuery('UPDATE `#__mt_config` SET `default` = \'kinabalu\' WHERE varname = \'template\' LIMIT 1');
		$database->execute();
		
		$database->setQuery('UPDATE `#__mt_config` SET `value` = \'/components/com_mtree/js/jquery-1.4.4.min.js\', `default` = \'/components/com_mtree/js/jquery-1.4.4.min.js\' WHERE varname = \'relative_path_to_js_library\' LIMIT 1');
		$database->execute();
		
		$database->setQuery('UPDATE `#__mt_fieldtypes` SET ft_class = \'class mFieldType_mFile extends mFieldType_file {\r\n	function getOutput() {\r\n	global $mtconf;\r\n	\r\n		$html = \'\';\r\n		$showCounter 	= $this->getParam(\'showCounter\',1);\r\n		$useImage		= $this->getParam(\'useImage\',\'\');\r\n		$showFilename	= $this->getParam(\'showFilename\',1);\r\n		$showText		= $this->getParam(\'showText\',\'\');\r\n		if(!empty($this->value))\r\n		{\r\n			$html .= \'<a href="\' . $this->getDataAttachmentURL() . \'" target="_blank">\';\r\n			if( !empty($useImage) )\r\n			{\r\n				$live_site = $mtconf->getjconf(\'live_site\');\r\n				$html .= \'<img src="\' . trim(str_replace(\'{live_site}\',$live_site,$useImage)) . \'"\';\r\n				$html .= \' alt=""\';\r\n				$html .= \' /> \';\r\n			} \r\n\r\n			if( !empty($showText) )\r\n			{\r\n				$html .= $showText . \' \';\r\n			}\r\n			\r\n			if( $showFilename == 1 )\r\n			{\r\n				$html .= $this->getValue();\r\n			}\r\n\r\n			$html .= \'</a>\';\r\n		}\r\n\r\n		$append_html = array();\r\n		if( $showCounter ) {\r\n			$append_html[] = JText::sprintf(\'COM_MTREE_NUMBER_OF_VIEWS\', $this->counter);\r\n		}\r\n\r\n		if( !empty($append_html) ) {\r\n			$html .= \' (\' . implode(\', \',$append_html) . \')\';\r\n		}\r\n		return $html;\r\n	}\r\n	function getJSValidation() {\r\n		$fileExtensions = $this->getParam(\'fileExtensions\',\'\');\r\n		if(is_array($fileExtensions)) {\r\n			$fileExtensions = implode(\'|\',$fileExtensions);\r\n		} else {\r\n			$fileExtensions = trim($fileExtensions);\r\n		}\r\n		if(!empty($fileExtensions)) {\r\n			$js = \'\';\r\n			$js .= \'} else if (!hasExt(form.\' .$this->getInputFieldName(1) . \'.value,\\\'\' . $fileExtensions . \'\\\')) {\'; \r\n			$js .= \'alert("\' . addslashes($this->getCaption()) . \': Please select files with these extension(s) - \' . str_replace(\'|\',\', \',$fileExtensions) . \'.");\';\r\n			return $js;\r\n		} else {\r\n			return null;\r\n		}\r\n	}\r\n}\' WHERE field_type = \'mfile\' LIMIT 1');
		$database->execute();
		
		$database->setQuery('ALTER TABLE `#__mt_customfields` ADD INDEX  `published_ordering` (  `published` ,  `ordering` )');
		$database->execute();
		
		// Insert MT kinabalu template if it does not already exists
		$database->setQuery('SELECT tem_id FROM `#__mt_templates` WHERE tem_name = \'kinabalu\';');
		$database->execute();
		
		if( $database->getNumRows() == 0 ) {
			$database->setQuery('INSERT IGNORE INTO `#__mt_templates` VALUES (\'\', \'kinabalu\', \'\');');
			$database->execute();
		}
		
		// Insert Checkbox with Image fieldtype
		$database->setQuery('SELECT ft_id FROM `#__mt_fieldtypes` WHERE field_type = \'checkboxWithImage\' LIMIT 1;');
		$database->execute();
		if( $database->getNumRows() == 0 ) {
			$database->setQuery('INSERT INTO #__mt_fieldtypes VALUES("", "checkboxWithImage", "Checkbox with Image", "class mFieldType_checkboxWithImage extends mFieldType_checkbox {\r\n	\r\n	function getInputHTML() {\r\n		$columns	= $this->getParam(\'columns\',1);\r\n		$useCaptions	= $this->getParam(\'useCaptions\',0);\r\n		$checkboxStyle	= $this->getParam(\'checkboxStyle\',\'\');\r\n\r\n		$i = 0;\r\n		$html = \'\';\r\n		if( $this->getValue() <> \'\' ) {\r\n			$checkbox_values = explode(\"|\",$this->getValue());\r\n		} else {\r\n			$checkbox_values = array();\r\n		}\r\n		foreach($this->arrayFieldElements AS $fieldElement) {\r\n			if($columns > 1) {\r\n				$html .= \'<div style=\"width:\' . floor(100 / $columns) . \'%;float:left;\">\';\r\n			}\r\n			$html .= \'<input type=\"checkbox\" name=\"\' . $this->getInputFieldName(1) . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getInputFieldName(1) . \'_\' . $i . \'\" \';\r\n			if(!empty($checkboxStyle)) {\r\n				$html .= \'style=\"\' . $checkboxStyle . \'\" \';\r\n			}\r\n			if( in_array($fieldElement,$checkbox_values) ) {\r\n				$html .= \'checked \';\r\n			}\r\n			$html .= \'/><label for=\"\' . $this->getInputFieldName(1) . \'_\' . $i . \'\">\';\r\n			\r\n			if( $useCaptions != 0 ) {\r\n				$html .= $this->getCheckboxLabel($i,true);\r\n			} else {\r\n				$html .= $this->getCheckboxLabel($i,false);\r\n			}\r\n			\r\n			$html .= \'</label><br>\';\r\n			if($columns > 1) {\r\n				$html .= \'</div>\';\r\n			}\r\n			$i++;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n	function getSearchHTML() {\r\n		$columns = $this->getParam(\'columns\',1);\r\n		$checkboxStyle = $this->getParam(\'checkboxStyle\',\'\');\r\n		$imageAlignment = $this->getParam(\'imageAlignment\',\'right\');\r\n		$i = 0;\r\n		$html = \'\';\r\n		foreach($this->arrayFieldElements AS $fieldElement) {\r\n			if($columns > 1) {\r\n				$html .= \'<div style=\"width:\' . floor(100 / $columns) . \'%;float:left;\">\';\r\n			}\r\n			switch($imageAlignment) {\r\n				case \'top\':\r\n				case \'left\':\r\n					$html .= \'<label for=\"\' . $this->getName() . \'_\' . $i . \'\">\';\r\n					$html .= $this->getCheckboxLabel($i);\r\n					$html .= \'</label>\';\r\n					if($imageAlignment == \'top\') {\r\n						$html .= \'<br />\';\r\n					}\r\n					$html .= \'<input type=\"checkbox\" name=\"\' . $this->getName() . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getName() . \'_\' . $i . \'\" \';\r\n					if(!empty($checkboxStyle)) {\r\n						$html .= \'style=\"\' . $checkboxStyle . \'\" \';\r\n					}\r\n					$html .= \'/><br />\';\r\n					break;\r\n				case \'right\':\r\n				default:\r\n					$html .= \'<input type=\"checkbox\" name=\"\' . $this->getName() . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getName() . \'_\' . $i . \'\" />\';\r\n					$html .= \'<label for=\"\' . $this->getName() . \'_\' . $i . \'\">\';\r\n					$html .= $this->getCheckboxLabel($i);\r\n					$html .= \'</label><br />\';\r\n					break;\r\n			}\r\n			if($columns > 1) {\r\n				$html .= \'</div>\';\r\n			}\r\n			$i++;\r\n		}\r\n		return $html;\r\n	}\r\n\r\n	\r\n	function getOutput($view=1) {\r\n		$useCaptions	= $this->getParam(\'useCaptions\',0);\r\n		$arrayValue 	= explode(\'|\',$this->value);\r\n		$arrOutput 		= array();\r\n		\r\n		foreach( $arrayValue AS $value ) {\r\n			if(array_search($value,$this->arrayFieldElements) !== false) {\r\n				if( $useCaptions == 1 ) {\r\n					$arrOutput[] = $this->getCheckboxLabel(array_search($value,$this->arrayFieldElements),true);\r\n				} else {\r\n					$arrOutput[] = $this->getCheckboxLabel(array_search($value,$this->arrayFieldElements),false);\r\n				}\r\n			}\r\n		}\r\n		$html = \'\';\r\n		switch($view) {\r\n			# Details view\r\n			case \'1\':\r\n				$html = \'\';\r\n				switch($this->getParam(\'dvOutput\',\'h\')) {\r\n					case \'ul\':\r\n						$html .= \'<ul><li>\' . implode(\'</li><li>\',$arrOutput). \'</li></ul>\';\r\n						break;\r\n					case \'ol\':\r\n						$html .= \'<ol><li>\' . implode(\'</li><li>\',$arrOutput). \'</li></ol>\';\r\n						break;\r\n					case \'v\':\r\n						$html .= implode(\'<br />\',$arrOutput);\r\n						break;\r\n					case \'h\':\r\n					default:\r\n						$html .= implode(\'&nbsp;\',$arrOutput);\r\n				}\r\n				break;\r\n			# Summary view\r\n			case \'2\':\r\n				$html .= implode(\'&nbsp;\',$arrOutput);\r\n				break;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n	function getCheckboxLabel($i,$showCaption=true) {\r\n		global $mtconf;\r\n		\r\n		$style 			= $this->getParam(\'style\'		, \'\'	);\r\n		$captions 		= $this->getParam(\'captions\'	, \'\'	);\r\n		$showImages 	= $this->getParam(\'showImages\'	, 1		);\r\n		$useCaptions 	= $this->getParam(\'useCaptions\'	, 0		);\r\n		$alts 			= $this->getParam(\'alts\'		, \'\'	);\r\n		$titles 		= $this->getParam(\'titles\'		, \'\'	);\r\n		$live_site 		= $mtconf->getjconf(\'live_site\'			);\r\n\r\n		if( $showCaption && $useCaptions != 0 ) {\r\n			$useCaptions = true;\r\n		} else {\r\n			$useCaptions = false;\r\n		}\r\n\r\n		$arrImages = $this->getParam(\'images\',\'\');\r\n		$arrAlts = $this->getParam(\'alts\',\'\');\r\n		$arrTitles = $this->getParam(\'titles\',\'\');\r\n		\r\n		if( !is_array($arrImages) ) {\r\n			$arrImages = explode(\"|\",$arrImages);\r\n		}\r\n		if( !is_array($arrAlts) ) {\r\n			$arrAlts = explode(\"|\",$arrAlts);\r\n		}\r\n		if( !is_array($arrTitles) ) {\r\n			$arrTitles = explode(\"|\",$arrTitles);\r\n		}\r\n		\r\n		// if(is_string($arrImages)) {\r\n		// 	$arrImages = array($arrImages);\r\n		// }\r\n		// if(is_string($arrAlts)) {\r\n		// 	$arrAlts = array($arrAlts);\r\n		// }\r\n		// if(is_string($arrTitles)) {\r\n		// 	$arrTitles = array($arrTitles);\r\n		// }\r\n		if(substr($live_site,-1)==\'/\') {\r\n			$live_site = substr($live_site,0,-1);\r\n		}\r\n		\r\n		$arrCaptions = array();\r\n		if($useCaptions && is_string($captions) ) {\r\n			$arrCaptions = explode(\'|\',$captions);\r\n		} elseif( is_array($captions) ) {\r\n			$arrCaptions = $captions;\r\n		}\r\n		\r\n		if(\r\n			is_numeric($i) && isset($arrImages[$i]) && !empty($arrImages[$i])\r\n			&&\r\n			(\r\n				($showImages == 1)\r\n				||\r\n				($showImages == 2 && !$this->inBackEnd())\r\n			)\r\n		) {\r\n			$html = \'\';\r\n			$html .= \'<img\';\r\n			if(!empty($style)) {\r\n				$html .= \' style=\"\' . $style . \'\"\';\r\n			}\r\n			$html .= \' src=\"\' . trim(str_replace(\'{live_site}\',$live_site,$arrImages[$i])) . \'\"\';\r\n			if(isset($arrAlts[$i]) && !empty($arrAlts[$i])) {\r\n				$html .= \' alt=\"\'.htmlspecialchars(trim($arrAlts[$i])).\'\"\';\r\n			} else {\r\n				$html .= \' alt=\"\'.htmlspecialchars(trim($this->arrayFieldElements[$i])).\'\"\';\r\n			}\r\n			if(isset($arrTitles[$i]) && !empty($arrTitles[$i])) {\r\n				$html .= \' title=\"\'.htmlspecialchars(trim(strip_tags($arrTitles[$i]))).\'\"\';\r\n			}\r\n			$html .= \' />\';\r\n			if($useCaptions && isset($arrCaptions[$i]) && !empty($arrCaptions[$i])) {\r\n				$html .= $arrCaptions[$i];\r\n			}\r\n			return $html;\r\n		} elseif( isset($arrCaptions[$i]) && !empty($arrCaptions[$i]) ) {\r\n			return $arrCaptions[$i];\r\n		} else {\r\n			return $this->arrayFieldElements[$i];\r\n			\r\n		}\r\n	}\r\n}", 1, 0, 0, 0, 0);');
			$database->execute();
			$ft_id = $database->insertid();
			
			// Insert checkboxWithImage fieldtype info
			$database->setQuery('INSERT INTO #__mt_fieldtypes_info VALUES("'.$ft_id.'", "14", "http://www.mosets.com", "This field type allows you to use image the check box label.");');
			$database->execute();

			// Update checkboxWithImage params.xml
			$database->setQuery("INSERT INTO #__mt_fieldtypes_att VALUES('', '".$ft_id."', 'params.xml', 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d7320616464706174683d222f61646d696e6973747261746f722f636f6d706f6e656e74732f636f6d5f6d747265652f656c656d656e7473223e09090a09093c706172616d206e616d653d22696d616765732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d6167657322206465736372697074696f6e3d22456e746572207468652055524c73206f6620696d6167657320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2055524c73206d75737420626520736570617261746564206279207c2e20596f752063616e20757365207b6c6976655f736974657d20617320746865207265706c6163656d656e7420666f72207468652076616c7565206f66206d6f73436f6e6669675f6c6976655f736974652e2069653a207b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f7a69702e706e677c7b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f6d70332e706e67222f3e0a09093c706172616d206e616d653d2273686f77496d616765732220747970653d226c697374222064656661756c743d223122206c6162656c3d2253686f7720496d6167657322206465736372697074696f6e3d22576865726520746f20646973706c61792074686520696d616765732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e2066726f6e742d656e643c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22696d616765416c69676e6d656e742220747970653d226c697374222064656661756c743d22726967687422206c6162656c3d22496d61676520416c69676e6d656e7422206465736372697074696f6e3d2253656c65637420776865726520616e20696d6167652077696c6c20626520646973706c617965642072656c617469766520746865206120636865636b626f782e223e0a0909093c6f7074696f6e2076616c75653d227269676874223e52696768743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d22746f70223e546f703c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226c656674223e4c6566743c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d227374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22435353205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20696d616765732e2042792064656661756c742c20697420697320656d7074792e2069653a20706f736974696f6e3a72656c61746976653b746f703a3470783b6c6566743a3270783b222f3e0a09093c706172616d206e616d653d22636865636b626f785374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22436865636b626f78205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20636865636b626f7865732e2042792064656661756c742c20697420697320656d7074792e2065673a20706f736974696f6e3a72656c61746976653b6c6566743a2d3270783b222f3e0a09093c706172616d206e616d653d2263617074696f6e732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d2243617074696f6e7322206465736372697074696f6e3d2243617074696f6e732061726520646973706c6179206265736964652074686520696d61676520746f2070726f7669646520612073686f7274206465736372697074696f6e206f66206561636820636865636b626f782e20456e746572207468652063617074696f6e7320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2043617074696f6e73206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2275736543617074696f6e732220747970653d226c697374222064656661756c743d223022206c6162656c3d2253686f772043617074696f6e7322206465736372697074696f6e3d22546f67676c652074686520646973706c6179206f662063617074696f6e732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e20456469742073637265656e3c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22616c74732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d61676520414c54732061747472696275746522206465736372697074696f6e3d22414c5473206174747269627574652061726520696e636c7564656420696e20796f757220696d61676520666f72206163636573736962696c69747920616e6420616c6c6f772075736572206167656e747320746861742063616e6e6f7420646973706c617920696d6167657320746f20757365207468697320617320616c7465726e6174656520746578742e204b6565702069742073686f727420616e6420707265636973652e20496620796f75206c65617665207468697320656d7074792c206669656c6420656c656d656e74732077696c6c206265207573656420666f7220746869732e20456e7465722074686520414c5420746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e20414c54207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d227469746c65732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d616765205449544c45732061747472696275746522206465736372697074696f6e3d22546869732077696c6c20626520616464656420746f20796f757220696d61676573206173205469746c65206174747269627574652e20557365207468697320746f2070726f76696465206164646974696f6e616c20696e666f726d6174696f6e20746f2065616368206f6620796f757220696d616765732e204d6f73742062726f777365727320646973706c6179207469746c652074657874206173206120746f6f6c746970207768656e20697420697320686f7665726564206f7665722e20456e74657220746865205449544c4520746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e205449544c45207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2264764f75747075742220747970653d226c697374222064656661756c743d226822206c6162656c3d2244657461696c7320766965772773206f7574707574223e0a0909093c6f7074696f6e2076616c75653d22756c223e556e6f726465726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226f6c223e4e756d6265726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2268223e486f72697a6f6e74616c6c793c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2276223e566572746963616c6c793c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22636f6c756d6e732220747970653d226c697374222064656661756c743d223122206c6162656c3d22436f6c756d6e7322206465736372697074696f6e3d22456e74657220746865206e756d626572206f6620636f6c756d6e732e223e0a0909093c6f7074696f6e2076616c75653d2231223e313c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e323c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2233223e333c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2234223e343c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2235223e353c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2236223e363c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2237223e373c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2238223e383c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2239223e393c2f6f7074696f6e3e0a09093c2f706172616d3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, 3544, 'text/xml', 1);");
			$database->execute();			
			$this->printStatus( 'Added checkboxWithImage field type.' );
		} else {
			$ft_id = $database->loadResult();
			
			// Update checkboxWithImage class code
			$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_checkboxWithImage extends mFieldType_checkbox {\r\n	\r\n	function getInputHTML() {\r\n		$columns	= $this->getParam(\'columns\',1);\r\n		$useCaptions	= $this->getParam(\'useCaptions\',0);\r\n		$checkboxStyle	= $this->getParam(\'checkboxStyle\',\'\');\r\n\r\n		$i = 0;\r\n		$html = \'\';\r\n		if( $this->getValue() <> \'\' ) {\r\n			$checkbox_values = explode(\"|\",$this->getValue());\r\n		} else {\r\n			$checkbox_values = array();\r\n		}\r\n		foreach($this->arrayFieldElements AS $fieldElement) {\r\n			if($columns > 1) {\r\n				$html .= \'<div style=\"width:\' . floor(100 / $columns) . \'%;float:left;\">\';\r\n			}\r\n			$html .= \'<input type=\"checkbox\" name=\"\' . $this->getInputFieldName(1) . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getInputFieldName(1) . \'_\' . $i . \'\" \';\r\n			if(!empty($checkboxStyle)) {\r\n				$html .= \'style=\"\' . $checkboxStyle . \'\" \';\r\n			}\r\n			if( in_array($fieldElement,$checkbox_values) ) {\r\n				$html .= \'checked \';\r\n			}\r\n			$html .= \'/><label for=\"\' . $this->getInputFieldName(1) . \'_\' . $i . \'\">\';\r\n			\r\n			if( $useCaptions != 0 ) {\r\n				$html .= $this->getCheckboxLabel($i,true);\r\n			} else {\r\n				$html .= $this->getCheckboxLabel($i,false);\r\n			}\r\n			\r\n			$html .= \'</label><br>\';\r\n			if($columns > 1) {\r\n				$html .= \'</div>\';\r\n			}\r\n			$i++;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n	function getSearchHTML() {\r\n		$columns = $this->getParam(\'columns\',1);\r\n		$checkboxStyle = $this->getParam(\'checkboxStyle\',\'\');\r\n		$imageAlignment = $this->getParam(\'imageAlignment\',\'right\');\r\n		$i = 0;\r\n		$html = \'\';\r\n		foreach($this->arrayFieldElements AS $fieldElement) {\r\n			if($columns > 1) {\r\n				$html .= \'<div style=\"width:\' . floor(100 / $columns) . \'%;float:left;\">\';\r\n			}\r\n			switch($imageAlignment) {\r\n				case \'top\':\r\n				case \'left\':\r\n					$html .= \'<label for=\"\' . $this->getName() . \'_\' . $i . \'\">\';\r\n					$html .= $this->getCheckboxLabel($i);\r\n					$html .= \'</label>\';\r\n					if($imageAlignment == \'top\') {\r\n						$html .= \'<br />\';\r\n					}\r\n					$html .= \'<input type=\"checkbox\" name=\"\' . $this->getName() . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getName() . \'_\' . $i . \'\" \';\r\n					if(!empty($checkboxStyle)) {\r\n						$html .= \'style=\"\' . $checkboxStyle . \'\" \';\r\n					}\r\n					$html .= \'/><br />\';\r\n					break;\r\n				case \'right\':\r\n				default:\r\n					$html .= \'<input type=\"checkbox\" name=\"\' . $this->getName() . \'[]\" value=\"\'.$fieldElement.\'\" id=\"\' . $this->getName() . \'_\' . $i . \'\" />\';\r\n					$html .= \'<label for=\"\' . $this->getName() . \'_\' . $i . \'\">\';\r\n					$html .= $this->getCheckboxLabel($i);\r\n					$html .= \'</label><br />\';\r\n					break;\r\n			}\r\n			if($columns > 1) {\r\n				$html .= \'</div>\';\r\n			}\r\n			$i++;\r\n		}\r\n		return $html;\r\n	}\r\n\r\n	\r\n	function getOutput($view=1) {\r\n		$useCaptions	= $this->getParam(\'useCaptions\',0);\r\n		$arrayValue 	= explode(\'|\',$this->value);\r\n		$arrOutput 		= array();\r\n		\r\n		foreach( $arrayValue AS $value ) {\r\n			if(array_search($value,$this->arrayFieldElements) !== false) {\r\n				if( $useCaptions == 1 ) {\r\n					$arrOutput[] = $this->getCheckboxLabel(array_search($value,$this->arrayFieldElements),true);\r\n				} else {\r\n					$arrOutput[] = $this->getCheckboxLabel(array_search($value,$this->arrayFieldElements),false);\r\n				}\r\n			}\r\n		}\r\n		$html = \'\';\r\n		switch($view) {\r\n			# Details view\r\n			case \'1\':\r\n				$html = \'\';\r\n				switch($this->getParam(\'dvOutput\',\'h\')) {\r\n					case \'ul\':\r\n						$html .= \'<ul><li>\' . implode(\'</li><li>\',$arrOutput). \'</li></ul>\';\r\n						break;\r\n					case \'ol\':\r\n						$html .= \'<ol><li>\' . implode(\'</li><li>\',$arrOutput). \'</li></ol>\';\r\n						break;\r\n					case \'v\':\r\n						$html .= implode(\'<br />\',$arrOutput);\r\n						break;\r\n					case \'h\':\r\n					default:\r\n						$html .= implode(\'&nbsp;\',$arrOutput);\r\n				}\r\n				break;\r\n			# Summary view\r\n			case \'2\':\r\n				$html .= implode(\'&nbsp;\',$arrOutput);\r\n				break;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n	function getCheckboxLabel($i,$showCaption=true) {\r\n		global $mtconf;\r\n		\r\n		$style 			= $this->getParam(\'style\'		, \'\'	);\r\n		$captions 		= $this->getParam(\'captions\'	, \'\'	);\r\n		$showImages 	= $this->getParam(\'showImages\'	, 1		);\r\n		$useCaptions 	= $this->getParam(\'useCaptions\'	, 0		);\r\n		$alts 			= $this->getParam(\'alts\'		, \'\'	);\r\n		$titles 		= $this->getParam(\'titles\'		, \'\'	);\r\n		$live_site 		= $mtconf->getjconf(\'live_site\'			);\r\n\r\n		if( $showCaption && $useCaptions != 0 ) {\r\n			$useCaptions = true;\r\n		} else {\r\n			$useCaptions = false;\r\n		}\r\n\r\n		$arrImages = $this->getParam(\'images\',\'\');\r\n		$arrAlts = $this->getParam(\'alts\',\'\');\r\n		$arrTitles = $this->getParam(\'titles\',\'\');\r\n		\r\n		if( !is_array($arrImages) ) {\r\n			$arrImages = explode(\"|\",$arrImages);\r\n		}\r\n		if( !is_array($arrAlts) ) {\r\n			$arrAlts = explode(\"|\",$arrAlts);\r\n		}\r\n		if( !is_array($arrTitles) ) {\r\n			$arrTitles = explode(\"|\",$arrTitles);\r\n		}\r\n		\r\n		// if(is_string($arrImages)) {\r\n		// 	$arrImages = array($arrImages);\r\n		// }\r\n		// if(is_string($arrAlts)) {\r\n		// 	$arrAlts = array($arrAlts);\r\n		// }\r\n		// if(is_string($arrTitles)) {\r\n		// 	$arrTitles = array($arrTitles);\r\n		// }\r\n		if(substr($live_site,-1)==\'/\') {\r\n			$live_site = substr($live_site,0,-1);\r\n		}\r\n		\r\n		$arrCaptions = array();\r\n		if($useCaptions && is_string($captions) ) {\r\n			$arrCaptions = explode(\'|\',$captions);\r\n		} elseif( is_array($captions) ) {\r\n			$arrCaptions = $captions;\r\n		}\r\n		\r\n		if(\r\n			is_numeric($i) && isset($arrImages[$i]) && !empty($arrImages[$i])\r\n			&&\r\n			(\r\n				($showImages == 1)\r\n				||\r\n				($showImages == 2 && !$this->inBackEnd())\r\n			)\r\n		) {\r\n			$html = \'\';\r\n			$html .= \'<img\';\r\n			if(!empty($style)) {\r\n				$html .= \' style=\"\' . $style . \'\"\';\r\n			}\r\n			$html .= \' src=\"\' . trim(str_replace(\'{live_site}\',$live_site,$arrImages[$i])) . \'\"\';\r\n			if(isset($arrAlts[$i]) && !empty($arrAlts[$i])) {\r\n				$html .= \' alt=\"\'.htmlspecialchars(trim($arrAlts[$i])).\'\"\';\r\n			} else {\r\n				$html .= \' alt=\"\'.htmlspecialchars(trim($this->arrayFieldElements[$i])).\'\"\';\r\n			}\r\n			if(isset($arrTitles[$i]) && !empty($arrTitles[$i])) {\r\n				$html .= \' title=\"\'.htmlspecialchars(trim(strip_tags($arrTitles[$i]))).\'\"\';\r\n			}\r\n			$html .= \' />\';\r\n			if($useCaptions && isset($arrCaptions[$i]) && !empty($arrCaptions[$i])) {\r\n				$html .= $arrCaptions[$i];\r\n			}\r\n			return $html;\r\n		} elseif( isset($arrCaptions[$i]) && !empty($arrCaptions[$i]) ) {\r\n			return $arrCaptions[$i];\r\n		} else {\r\n			return $this->arrayFieldElements[$i];\r\n			\r\n		}\r\n	}\r\n}"  WHERE field_type = "checkboxWithImage" LIMIT 1');
			$database->execute();

			// Update checkboxWithImage version number
			$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "14" WHERE ft_id = "'.$ft_id.'" LIMIT 1');
			$database->execute();

			// Update checkboxWithImage params.xml
			$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3C6D6F73706172616D7320747970653D226D6F64756C65223E0A093C706172616D7320616464706174683D222F61646D696E6973747261746F722F636F6D706F6E656E74732F636F6D5F6D747265652F656C656D656E7473223E09090A09093C706172616D206E616D653D22696D616765732220747970653D227069706564746578742220636F6C733D2234302220726F77733D2236222064656661756C743D2222206C6162656C3D22496D6167657322206465736372697074696F6E3D22456E746572207468652055524C73206F6620696D6167657320636F72726573706F6E64696E6720746F2074686520656C656D656E747320646566696E656420666F72207468697320637573746F6D206669656C642E2055524C73206D75737420626520736570617261746564206279207C2E20596F752063616E20757365207B6C6976655F736974657D20617320746865207265706C6163656D656E7420666F72207468652076616C7565206F66206D6F73436F6E6669675F6C6976655F736974652E2069653A207B6C6976655F736974657D2F6D656469612F6D656469612F696D616765732F6D696D652D69636F6E2D33322F7A69702E706E677C7B6C6976655F736974657D2F6D656469612F6D656469612F696D616765732F6D696D652D69636F6E2D33322F6D70332E706E67222F3E0A09093C706172616D206E616D653D2273686F77496D616765732220747970653D226C697374222064656661756C743D223122206C6162656C3D2253686F7720496D6167657322206465736372697074696F6E3D22576865726520746F20646973706C61792074686520696D616765732E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2232223E4F6E6C7920696E2066726F6E742D656E643C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22696D616765416C69676E6D656E742220747970653D226C697374222064656661756C743D22726967687422206C6162656C3D22496D61676520416C69676E6D656E7422206465736372697074696F6E3D2253656C65637420776865726520616E20696D6167652077696C6C20626520646973706C617965642072656C617469766520746865206120636865636B626F782E223E0A0909093C6F7074696F6E2076616C75653D227269676874223E52696768743C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D22746F70223E546F703C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D226C656674223E4C6566743C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D227374796C652220747970653D2274657874222073697A653D223434222064656661756C743D2222206C6162656C3D22435353205374796C6522206465736372697074696F6E3D225374796C6520746F206265206170706C69656420746F20696D616765732E2042792064656661756C742C20697420697320656D7074792E2069653A20706F736974696F6E3A72656C61746976653B746F703A3470783B6C6566743A3270783B222F3E0A09093C706172616D206E616D653D22636865636B626F785374796C652220747970653D2274657874222073697A653D223434222064656661756C743D2222206C6162656C3D22436865636B626F78205374796C6522206465736372697074696F6E3D225374796C6520746F206265206170706C69656420746F20636865636B626F7865732E2042792064656661756C742C20697420697320656D7074792E2065673A20706F736974696F6E3A72656C61746976653B6C6566743A2D3270783B222F3E0A09093C706172616D206E616D653D2263617074696F6E732220747970653D227069706564746578742220636F6C733D2234302220726F77733D2236222064656661756C743D2222206C6162656C3D2243617074696F6E7322206465736372697074696F6E3D2243617074696F6E732061726520646973706C6179206265736964652074686520696D61676520746F2070726F7669646520612073686F7274206465736372697074696F6E206F66206561636820636865636B626F782E20456E746572207468652063617074696F6E7320636F72726573706F6E64696E6720746F2074686520656C656D656E747320646566696E656420666F72207468697320637573746F6D206669656C642E2043617074696F6E73206D75737420626520736570617261746564206279207C2E222F3E0A09093C706172616D206E616D653D2275736543617074696F6E732220747970653D226C697374222064656661756C743D223022206C6162656C3D2253686F772043617074696F6E7322206465736372697074696F6E3D22546F67676C652074686520646973706C6179206F662063617074696F6E732E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2232223E4F6E6C7920696E20456469742073637265656E3C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22616C74732220747970653D227069706564746578742220636F6C733D2234302220726F77733D2236222064656661756C743D2222206C6162656C3D22496D61676520414C54732061747472696275746522206465736372697074696F6E3D22414C5473206174747269627574652061726520696E636C7564656420696E20796F757220696D61676520666F72206163636573736962696C69747920616E6420616C6C6F772075736572206167656E747320746861742063616E6E6F7420646973706C617920696D6167657320746F20757365207468697320617320616C7465726E6174656520746578742E204B6565702069742073686F727420616E6420707265636973652E20496620796F75206C65617665207468697320656D7074792C206669656C6420656C656D656E74732077696C6C206265207573656420666F7220746869732E20456E7465722074686520414C5420746578747320636F72726573706F6E64696E6720746F2074686520656C656D656E747320646566696E656420666F72207468697320637573746F6D206669656C642E20414C54207465787473206D75737420626520736570617261746564206279207C2E222F3E0A09093C706172616D206E616D653D227469746C65732220747970653D227069706564746578742220636F6C733D2234302220726F77733D2236222064656661756C743D2222206C6162656C3D22496D616765205449544C45732061747472696275746522206465736372697074696F6E3D22546869732077696C6C20626520616464656420746F20796F757220696D61676573206173205469746C65206174747269627574652E20557365207468697320746F2070726F76696465206164646974696F6E616C20696E666F726D6174696F6E20746F2065616368206F6620796F757220696D616765732E204D6F73742062726F777365727320646973706C6179207469746C652074657874206173206120746F6F6C746970207768656E20697420697320686F7665726564206F7665722E20456E74657220746865205449544C4520746578747320636F72726573706F6E64696E6720746F2074686520656C656D656E747320646566696E656420666F72207468697320637573746F6D206669656C642E205449544C45207465787473206D75737420626520736570617261746564206279207C2E222F3E0A09093C706172616D206E616D653D2264764F75747075742220747970653D226C697374222064656661756C743D226822206C6162656C3D2244657461696C7320766965772773206F7574707574223E0A0909093C6F7074696F6E2076616C75653D22756C223E556E6F726465726564204C6973743C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D226F6C223E4E756D6265726564204C6973743C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2268223E486F72697A6F6E74616C6C793C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2276223E566572746963616C6C793C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22636F6C756D6E732220747970653D226C697374222064656661756C743D223122206C6162656C3D22436F6C756D6E7322206465736372697074696F6E3D22456E74657220746865206E756D626572206F6620636F6C756D6E732E223E0A0909093C6F7074696F6E2076616C75653D2231223E313C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2232223E323C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2233223E333C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2234223E343C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2235223E353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2236223E363C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2237223E373C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2238223E383C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2239223E393C2F6F7074696F6E3E0A09093C2F706172616D3E0A093C2F706172616D733E0A3C2F6D6F73706172616D733E, filesize = 3544 WHERE ft_id = ".$ft_id." AND filename = 'params.xml' LIMIT 1");
			$database->execute();
			$this->printStatus( 'Updated checkboxWithImage field type to version 14.' );
		}

		// Insert Enhanced Weblink field type
		$database->setQuery('SELECT ft_id FROM `#__mt_fieldtypes` WHERE field_type = \'enhancedWeblink\' LIMIT 1;');
		$database->execute();
		if( $database->getNumRows() == 0 ) {
			$database->setQuery('INSERT INTO #__mt_fieldtypes VALUES("", "enhancedWeblink", "Enhanced Weblink", "class mFieldType_enhancedWeblink extends mFieldType_weblink {\r\n	\r\n	var $acceptedProtocols = array(\'http\',\'https\');\r\n	var $defaultPrefix = \'http://\';\r\n	\r\n	function getJSValidation() {\r\n		$acceptedProtocols = $this->getAcceptedProtocols();\r\n		$arrProtocolRegex = array();\r\n		foreach( $acceptedProtocols AS $acceptedProtocol )\r\n		{\r\n			$arrProtocolRegex[] = $acceptedProtocol . \':\\\\/\\\\/\';\r\n		}\r\n		\r\n		$js = \'\';\r\n		$js .= \'} else if (form.\' .$this->getName() . \'.value != \"\" && /^(\'.implode(\'|\',$arrProtocolRegex).\')?(([a-zA-Z0-9]+\\\\.[a-zA-Z0-9\\\\-]+|[a-zA-Z0-9\\\\-]+)\\\\.[a-zA-Z\\\\.]{2,6}|[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3})(\\\\/[a-zA-Z0-9\\\\.\\\\?=\\\\/#%&\\\\+-]+|\\\\/|)/i.test(form.\' .$this->getName() . \'.value)==false) {\'; \r\n		$js .= \'alert(\"\' . $this->getCaption() . \': \' . JText::_( \'Please enter a valid url\' ) . \'\");\';\r\n		return $js;\r\n	}\r\n\r\n	function parseValue($value)\r\n	{\r\n		$value = trim(strip_tags($value));\r\n		$protocol = substr($value,0,strpos($value,\':\'));\r\n		$acceptedProtocols = $this->getAcceptedProtocols();\r\n		\r\n		if( $protocol !== false )\r\n		{\r\n			if( in_array($protocol,$acceptedProtocols) ) {\r\n				return $value;\r\n			} else {\r\n				return $this->defaultPrefix . $value;\r\n			}\r\n		}\r\n		elseif(!empty($value))\r\n		{\r\n			return $this->defaultPrefix . $value;\r\n		}\r\n		else\r\n		{\r\n			return \'\';\r\n		}\r\n	}\r\n	\r\n	function getAcceptedProtocols()\r\n	{\r\n		$acceptFTP = $this->getParam( \'acceptFTP\', 0 );\r\n		\r\n		$acceptedProtocols = $this->acceptedProtocols;\r\n		if($acceptFTP) {\r\n			array_push($acceptedProtocols,\'ftp\');\r\n		}\r\n\r\n		return $acceptedProtocols;\r\n	}\r\n	\r\n	function getValue($arg=null) \r\n	{ \r\n		if(defined(\'JVERSION\')) {\r\n			$my	=& JFactory::getUser();\r\n		} else {\r\n			global $my;\r\n		}\r\n\r\n		$accessLevel 	= $this->getParam(\'accessLevel\',0);\r\n		$txtLogin 		= $this->getParam(\'txtLogin\',\'\');\r\n\r\n		if($accessLevel >= 1 && $my->id == 0 && empty($txtLogin)) {\r\n			return \'\';\r\n		} else {\r\n			return $this->value;\r\n		}\r\n	}\r\n	\r\n	function getOutput() \r\n	{\r\n		if(defined(\'JVERSION\')) {\r\n			$my	=& JFactory::getUser();\r\n		} else {\r\n			global $my;\r\n		}\r\n		\r\n		$maxUrlLength 			= $this->getParam(\'maxUrlLength\',60);\r\n		$text 					= $this->getParam(\'text\',\'\');\r\n		$title 					= $this->getParam(\'title\',\'\');\r\n		$image					= $this->getParam(\'image\',\'\');\r\n		$openNewWindow 			= $this->getParam(\'openNewWindow\',1);\r\n		$accessLevel 			= $this->getParam(\'accessLevel\',0);\r\n		$txtLogin 				= $this->getParam(\'txtLogin\',\'\');\r\n		$useNofollow			= $this->getParam(\'useNofollow\',0);\r\n		$useGA 					= $this->getParam(\'useGA\',0);\r\n		$gaPageTrackDirectory	= $this->getParam(\'gaPageTrackDirectory\',\'/outgoing/\');\r\n	\r\n		if($accessLevel >= 1 && $my->id == 0) {\r\n			return $txtLogin;\r\n		}\r\n		\r\n		$html = \'\';\r\n		$html .= \'<a href=\"\' . $this->getValue() . \'\"\';\r\n		if( $openNewWindow == 1 ) {\r\n			$html .= \' target=\"_blank\"\';\r\n		}\r\n		if( !empty($title) ) {\r\n			$html .= \' title=\"\' . $title . \'\"\';\r\n		}\r\n		if($useNofollow) {\r\n			$html .= \' rel=\"nofollow\"\';\r\n		}\r\n		if($useGA) {\r\n			$html .= \' onClick=\"javascript: pageTracker._trackPageview(\\\\\'\' . $gaPageTrackDirectory . $this->striphttp($this->getValue()) . \'\\\\\');\"\';\r\n		}\r\n		$html .= \'>\';\r\n		if(!empty($image)) {\r\n			global $mtconf;\r\n			$live_site = $mtconf->getjconf(\'live_site\');\r\n			$html .= \'<img src=\"\' . trim(str_replace(\'{live_site}\',$live_site,$image)) . \'\"\';\r\n			$html .= \' alt=\"\' . $text . \'\"\';\r\n			$html .= \' />\';\r\n		}elseif(!empty($text)) {\r\n			$html .= $text;\r\n		} else {\r\n			$value = $this->striphttp($this->getValue());\r\n			if( empty($maxUrlLength) || $maxUrlLength == 0 ) {\r\n				$html .= $value;\r\n			} else {\r\n				$html .= substr($value,0,$maxUrlLength);\r\n				if( strlen($value) > $maxUrlLength ) {\r\n					$html .= $this->getParam(\'clippedSymbol\');\r\n				}\r\n			}\r\n		}\r\n		$html .= \'</a>\';\r\n		return $html;\r\n	}\r\n	\r\n	function striphttp($url) {\r\n		$return = \'\';\r\n		if(strpos($url,\'://\') !== false) {\r\n			$return = substr($url,(strpos($url,\'://\')+3));\r\n		} else {\r\n			return $url;\r\n		}\r\n		return $return;\r\n	}\r\n}", 1, 0, 0, 0, 0);');
			$database->execute();
			$ft_id = $database->insertid();
			
			// Insert enhancedWeblink field type info
			$database->setQuery('INSERT INTO #__mt_fieldtypes_info VALUES("'.$ft_id.'", "7", "http://www.mosets.com", "");');
			$database->execute();

			// Insert enhancedWeblink params.xml
			$database->setQuery("INSERT INTO #__mt_fieldtypes_att VALUES('', '".$ft_id."', 'params.xml', 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d7320616464706174683d222f61646d696e6973747261746f722f636f6d706f6e656e74732f636f6d5f6d747265652f656c656d656e7473223e09090a09093c706172616d206e616d653d22696d616765732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d6167657322206465736372697074696f6e3d22456e746572207468652055524c73206f6620696d6167657320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2055524c73206d75737420626520736570617261746564206279207c2e20596f752063616e20757365207b6c6976655f736974657d20617320746865207265706c6163656d656e7420666f72207468652076616c7565206f66206d6f73436f6e6669675f6c6976655f736974652e2069653a207b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f7a69702e706e677c7b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f6d70332e706e67222f3e0a09093c706172616d206e616d653d2273686f77496d616765732220747970653d226c697374222064656661756c743d223122206c6162656c3d2253686f7720496d6167657322206465736372697074696f6e3d22576865726520746f20646973706c61792074686520696d616765732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e2066726f6e742d656e643c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22696d616765416c69676e6d656e742220747970653d226c697374222064656661756c743d22726967687422206c6162656c3d22496d61676520416c69676e6d656e7422206465736372697074696f6e3d2253656c65637420776865726520616e20696d6167652077696c6c20626520646973706c617965642072656c617469766520746865206120636865636b626f782e223e0a0909093c6f7074696f6e2076616c75653d227269676874223e52696768743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d22746f70223e546f703c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226c656674223e4c6566743c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d227374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22435353205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20696d616765732e2042792064656661756c742c20697420697320656d7074792e2069653a20706f736974696f6e3a72656c61746976653b746f703a3470783b6c6566743a3270783b222f3e0a09093c706172616d206e616d653d22636865636b626f785374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22436865636b626f78205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20636865636b626f7865732e2042792064656661756c742c20697420697320656d7074792e2065673a20706f736974696f6e3a72656c61746976653b6c6566743a2d3270783b222f3e0a09093c706172616d206e616d653d2263617074696f6e732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d2243617074696f6e7322206465736372697074696f6e3d2243617074696f6e732061726520646973706c6179206265736964652074686520696d61676520746f2070726f7669646520612073686f7274206465736372697074696f6e206f66206561636820636865636b626f782e20456e746572207468652063617074696f6e7320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2043617074696f6e73206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2275736543617074696f6e732220747970653d226c697374222064656661756c743d223022206c6162656c3d2253686f772043617074696f6e7322206465736372697074696f6e3d22546f67676c652074686520646973706c6179206f662063617074696f6e732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e20456469742073637265656e3c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22616c74732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d61676520414c54732061747472696275746522206465736372697074696f6e3d22414c5473206174747269627574652061726520696e636c7564656420696e20796f757220696d61676520666f72206163636573736962696c69747920616e6420616c6c6f772075736572206167656e747320746861742063616e6e6f7420646973706c617920696d6167657320746f20757365207468697320617320616c7465726e6174656520746578742e204b6565702069742073686f727420616e6420707265636973652e20496620796f75206c65617665207468697320656d7074792c206669656c6420656c656d656e74732077696c6c206265207573656420666f7220746869732e20456e7465722074686520414c5420746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e20414c54207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d227469746c65732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d616765205449544c45732061747472696275746522206465736372697074696f6e3d22546869732077696c6c20626520616464656420746f20796f757220696d61676573206173205469746c65206174747269627574652e20557365207468697320746f2070726f76696465206164646974696f6e616c20696e666f726d6174696f6e20746f2065616368206f6620796f757220696d616765732e204d6f73742062726f777365727320646973706c6179207469746c652074657874206173206120746f6f6c746970207768656e20697420697320686f7665726564206f7665722e20456e74657220746865205449544c4520746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e205449544c45207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2264764f75747075742220747970653d226c697374222064656661756c743d226822206c6162656c3d2244657461696c7320766965772773206f7574707574223e0a0909093c6f7074696f6e2076616c75653d22756c223e556e6f726465726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226f6c223e4e756d6265726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2268223e486f72697a6f6e74616c6c793c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2276223e566572746963616c6c793c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22636f6c756d6e732220747970653d226c697374222064656661756c743d223122206c6162656c3d22436f6c756d6e7322206465736372697074696f6e3d22456e74657220746865206e756d626572206f6620636f6c756d6e732e223e0a0909093c6f7074696f6e2076616c75653d2231223e313c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e323c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2233223e333c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2234223e343c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2235223e353c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2236223e363c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2237223e373c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2238223e383c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2239223e393c2f6f7074696f6e3e0a09093c2f706172616d3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, 3544, 'text/xml', 1);");
			$database->execute();			
			$this->printStatus( 'Added enhancedWeblink field type.' );
		} else {
			$ft_id = $database->loadResult();
			
			// Update enhancedWeblink class code
			$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_enhancedWeblink extends mFieldType_weblink {\r\n	\r\n	var $acceptedProtocols = array(\'http\',\'https\');\r\n	var $defaultPrefix = \'http://\';\r\n	\r\n	function getJSValidation() {\r\n		$acceptedProtocols = $this->getAcceptedProtocols();\r\n		$arrProtocolRegex = array();\r\n		foreach( $acceptedProtocols AS $acceptedProtocol )\r\n		{\r\n			$arrProtocolRegex[] = $acceptedProtocol . \':\\\\/\\\\/\';\r\n		}\r\n		\r\n		$js = \'\';\r\n		$js .= \'} else if (form.\' .$this->getName() . \'.value != \"\" && /^(\'.implode(\'|\',$arrProtocolRegex).\')?(([a-zA-Z0-9]+\\\\.[a-zA-Z0-9\\\\-]+|[a-zA-Z0-9\\\\-]+)\\\\.[a-zA-Z\\\\.]{2,6}|[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3}\\\\.[0-9]{1,3})(\\\\/[a-zA-Z0-9\\\\.\\\\?=\\\\/#%&\\\\+-]+|\\\\/|)/i.test(form.\' .$this->getName() . \'.value)==false) {\'; \r\n		$js .= \'alert(\"\' . $this->getCaption() . \': \' . JText::_( \'Please enter a valid url\' ) . \'\");\';\r\n		return $js;\r\n	}\r\n\r\n	function parseValue($value)\r\n	{\r\n		$value = trim(strip_tags($value));\r\n		$protocol = substr($value,0,strpos($value,\':\'));\r\n		$acceptedProtocols = $this->getAcceptedProtocols();\r\n		\r\n		if( $protocol !== false )\r\n		{\r\n			if( in_array($protocol,$acceptedProtocols) ) {\r\n				return $value;\r\n			} else {\r\n				return $this->defaultPrefix . $value;\r\n			}\r\n		}\r\n		elseif(!empty($value))\r\n		{\r\n			return $this->defaultPrefix . $value;\r\n		}\r\n		else\r\n		{\r\n			return \'\';\r\n		}\r\n	}\r\n	\r\n	function getAcceptedProtocols()\r\n	{\r\n		$acceptFTP = $this->getParam( \'acceptFTP\', 0 );\r\n		\r\n		$acceptedProtocols = $this->acceptedProtocols;\r\n		if($acceptFTP) {\r\n			array_push($acceptedProtocols,\'ftp\');\r\n		}\r\n\r\n		return $acceptedProtocols;\r\n	}\r\n	\r\n	function getValue($arg=null) \r\n	{ \r\n		if(defined(\'JVERSION\')) {\r\n			$my	=& JFactory::getUser();\r\n		} else {\r\n			global $my;\r\n		}\r\n\r\n		$accessLevel 	= $this->getParam(\'accessLevel\',0);\r\n		$txtLogin 		= $this->getParam(\'txtLogin\',\'\');\r\n\r\n		if($accessLevel >= 1 && $my->id == 0 && empty($txtLogin)) {\r\n			return \'\';\r\n		} else {\r\n			return $this->value;\r\n		}\r\n	}\r\n	\r\n	function getOutput() \r\n	{\r\n		if(defined(\'JVERSION\')) {\r\n			$my	=& JFactory::getUser();\r\n		} else {\r\n			global $my;\r\n		}\r\n		\r\n		$maxUrlLength 			= $this->getParam(\'maxUrlLength\',60);\r\n		$text 					= $this->getParam(\'text\',\'\');\r\n		$title 					= $this->getParam(\'title\',\'\');\r\n		$image					= $this->getParam(\'image\',\'\');\r\n		$openNewWindow 			= $this->getParam(\'openNewWindow\',1);\r\n		$accessLevel 			= $this->getParam(\'accessLevel\',0);\r\n		$txtLogin 				= $this->getParam(\'txtLogin\',\'\');\r\n		$useNofollow			= $this->getParam(\'useNofollow\',0);\r\n		$useGA 					= $this->getParam(\'useGA\',0);\r\n		$gaPageTrackDirectory	= $this->getParam(\'gaPageTrackDirectory\',\'/outgoing/\');\r\n	\r\n		if($accessLevel >= 1 && $my->id == 0) {\r\n			return $txtLogin;\r\n		}\r\n		\r\n		$html = \'\';\r\n		$html .= \'<a href=\"\' . $this->getValue() . \'\"\';\r\n		if( $openNewWindow == 1 ) {\r\n			$html .= \' target=\"_blank\"\';\r\n		}\r\n		if( !empty($title) ) {\r\n			$html .= \' title=\"\' . $title . \'\"\';\r\n		}\r\n		if($useNofollow) {\r\n			$html .= \' rel=\"nofollow\"\';\r\n		}\r\n		if($useGA) {\r\n			$html .= \' onClick=\"javascript: pageTracker._trackPageview(\\\\\'\' . $gaPageTrackDirectory . $this->striphttp($this->getValue()) . \'\\\\\');\"\';\r\n		}\r\n		$html .= \'>\';\r\n		if(!empty($image)) {\r\n			global $mtconf;\r\n			$live_site = $mtconf->getjconf(\'live_site\');\r\n			$html .= \'<img src=\"\' . trim(str_replace(\'{live_site}\',$live_site,$image)) . \'\"\';\r\n			$html .= \' alt=\"\' . $text . \'\"\';\r\n			$html .= \' />\';\r\n		}elseif(!empty($text)) {\r\n			$html .= $text;\r\n		} else {\r\n			$value = $this->striphttp($this->getValue());\r\n			if( empty($maxUrlLength) || $maxUrlLength == 0 ) {\r\n				$html .= $value;\r\n			} else {\r\n				$html .= substr($value,0,$maxUrlLength);\r\n				if( strlen($value) > $maxUrlLength ) {\r\n					$html .= $this->getParam(\'clippedSymbol\');\r\n				}\r\n			}\r\n		}\r\n		$html .= \'</a>\';\r\n		return $html;\r\n	}\r\n	\r\n	function striphttp($url) {\r\n		$return = \'\';\r\n		if(strpos($url,\'://\') !== false) {\r\n			$return = substr($url,(strpos($url,\'://\')+3));\r\n		} else {\r\n			return $url;\r\n		}\r\n		return $return;\r\n	}\r\n}"  WHERE field_type = "enhancedWeblink" LIMIT 1');
			$database->execute();

			// Update enhancedWeblink version number
			$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "7" WHERE ft_id = "'.$ft_id.'" LIMIT 1');
			$database->execute();

			// Update enhancedWeblink params.xml
			$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3C6D6F73706172616D7320747970653D226D6F64756C65223E0A093C706172616D733E0A09093C706172616D206E616D653D226F70656E4E657757696E646F772220747970653D22726164696F222064656661756C743D223122206C6162656C3D224F70656E204E65772057696E646F7722206465736372697074696F6E3D224F70656E2061206E65772077696E646F77207768656E20746865206C696E6B20697320636C69636B65642E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22746578742220747970653D2274657874222064656661756C743D22222073697A653D22343022206C6162656C3D224C696E6B205465787422206465736372697074696F6E3D22557365207468697320706172616D6574657220746F207370656369667920746865206C696E6B20746578742E204966206C65667420656D7074792C207468652066756C6C2055524C2077696C6C20626520646973706C6179656420617320746865206C696E6B277320746578742E20496620796F75207370656369667920616E20696D6167652062656C6F772C20746869732077696C6C206265207573656420666F722069747320414C54206174747269627574652E222F3E0A09093C706172616D206E616D653D227469746C652220747970653D2274657874222064656661756C743D22222073697A653D22343022206C6162656C3D224C696E6B205469746C6522206465736372697074696F6E3D22546869732077696C6C20626520616464656420746F20796F7572206C696E6B206173205469746C65206174747269627574652E20557365207468697320746F2070726F76696465206164646974696F6E616C20696E666F726D6174696F6E2061626F757420796F7572206C696E6B2E204D6F73742062726F777365727320646973706C6179207469746C652074657874206173206120746F6F6C746970207768656E20697420697320686F7665726564206F7665722E222F3E0A09093C706172616D206E616D653D22696D6167652220747970653D2274657874222064656661756C743D22222073697A653D22343022206C6162656C3D224C696E6B20496D61676522206465736372697074696F6E3D22456E746572207468652055524C206F6620616E20696D6167652E20546869732077696C6C206265207573656420666F7220746865207765626C696E6B20696E7374656164206F6620746865207765626C696E6B2055524C2E20596F752063616E20757365207B6C6976655F736974657D20617320746865207265706C6163656D656E7420666F72207468652076616C7565206F66206D6F73436F6E6669675F6C6976655F736974652E2069653A207B6C6976655F736974657D2F696D616765732F62616E6E6572732F77686974652E706E67222F3E0A09093C706172616D206E616D653D226D617855726C4C656E6774682220747970653D2274657874222073697A653D223130222064656661756C743D22363022206C6162656C3D224D61782E2055524C204C656E67746822206465736372697074696F6E3D22456E74657220746865206D6178696D756D2055524C2773206C656E677468206265666F726520697420697320636C6970706564222F3E0A09093C706172616D206E616D653D22636C697070656453796D626F6C2220747970653D2274657874222073697A653D223130222064656661756C743D222E2E2E22206C6162656C3D22436C69707065642073796D626F6C222F3E0A09093C706172616D206E616D653D2273686F77476F2220747970653D22726164696F222064656661756C743D223022206C6162656C3D2253686F7720476F20627574746F6E22206465736372697074696F6E3D225468697320476F20627574746F6E2077696C6C20626520617661696C61626C6520696E20746865206261636B2D656E642045646974204C697374696E67207061676520746F20616C6C6F772061646D696E206120666173742077617920746F206F70656E20746865206C697374696E67277320776562736974652E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09090A09093C706172616D20747970653D2273706163657222206E616D653D224073706163657222206C6162656C3D2222206465736372697074696F6E3D22222F3E0A0A09093C706172616D206E616D653D226163636570744654502220747970653D22726164696F222064656661756C743D223022206C6162656C3D2241636365707420465450206C696E6B7322206465736372697074696F6E3D2253657474696E67207468697320746F205965732077696C6C20656E61626C65207468697320637573746F6D206669656C6420746F20616363657074206C696E6B732077697468206674703A2F2F2070726F746F636F6C2E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09090A09093C706172616D20747970653D2273706163657222206E616D653D224073706163657222206C6162656C3D2222206465736372697074696F6E3D22222F3E0A09090A09093C706172616D206E616D653D226163636573734C6576656C2220747970653D226C697374222064656661756C743D223022206C6162656C3D22416363657373204C6576656C22206465736372697074696F6E3D225365742074686520726571756972656420616363657373206C6576656C20696E206F7264657220666F7220796F757220757365727320746F20766965772074686973206C696E6B2E223E0A0909093C6F7074696F6E2076616C75653D2230223E5075626C69633C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E526567697374657265643C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D227478744C6F67696E2220747970653D2274657874222064656661756C743D22222073697A653D22343022206C6162656C3D224C6F67696E204D65737361676522206465736372697074696F6E3D22496620796F752776652073657420746865206669656C64277320416363657373204C6576656C20746F20526567697374657265642C2074686973206D6573736167652077696C6C2062652073686F7773207768656E20756E72656769737465726564207573657273207669657720746865206669656C642E222F3E0A09090A09093C706172616D20747970653D2273706163657222206E616D653D224073706163657222206C6162656C3D2222206465736372697074696F6E3D22222F3E0A0A09093C706172616D206E616D653D227573654E6F666F6C6C6F772220747970653D22726164696F222064656661756C743D223022206C6162656C3D22456E61626C65206E6F666F6C6C6F772061747472696275746522206465736372697074696F6E3D226E6F666F6C6C6F7720697320616E2048544D4C206174747269627574652076616C7565207573656420746F20696E73747275637420736F6D652073656172636820656E67696E6573207468617420612068797065726C696E6B2073686F756C64206E6F7420696E666C75656E636520746865206C696E6B2074617267657427732072616E6B696E6720696E207468652073656172636820656E67696E65277320696E6465782E20456E61626C696E67207468697320706172616D657465722077696C6C20617070656E6420746865206E6F666F6C6C6F772061747472696275746520746F20616C6C206C696E6B732063726561746564207573696E672074686973206669656C6420747970652E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A0A09093C706172616D20747970653D2273706163657222206E616D653D224073706163657222206C6162656C3D2222206465736372697074696F6E3D22222F3E0A0A09093C706172616D206E616D653D2275736547412220747970653D22726164696F222064656661756C743D223022206C6162656C3D2255736520474120747261636B696E6722206465736372697074696F6E3D22496620796F752073697465207573657320476F6F676C6520416E616C79746963732C207468697320616C6C6F777320796F7520746F20747261636B206F7574626F756E64206C696E6B207468726F7567682074686973206669656C642E20506C65617365206D616B65207375726520796F75206861766520476F6F676C6520416E616C79746963732072756E6E696E67206F6E20796F7572207369746520616E64206861766520746865206C61746573742076657273696F6E206F662074686520747261636B696E6720636F6465206265666F7265207573696E6720746869732E223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22676150616765547261636B4469726563746F72792220747970653D2274657874222064656661756C743D222F6F7574676F696E672F222073697A653D22343022206C6162656C3D2247412773206F7574626F756E64206469726563746F727922206465736372697074696F6E3D22496620796F752075736520476F6F676C6520416E616C79746963732C207468697320706172616D6574657220616C6C6F7720796F7520746F20656E74657220616E206F7574676F696E67206469726563746F727920776865726520616C6C206F7574626F756E6420636C69636B73207468726F7567682074686973206669656C642077696C6C206265207265636F726465642E204D6F726520696E666F726D6174696F6E3A20687474703A2F2F7777772E676F6F676C652E636F6D2F737570706F72742F616E616C79746963732F62696E2F616E737765722E70793F616E737765723D353535323726616D703B636269643D3161756C3537796B6A727A646426616D703B7372633D6362222F3E0A0A093C2F706172616D733E0A3C2F6D6F73706172616D733E, filesize = 3887 WHERE ft_id = ".$ft_id." AND filename = 'params.xml' LIMIT 1");
			$database->execute();
			$this->printStatus( 'Updated enhancedWeblink field type to version 7.' );
		}
		
		// Insert Enhanced Text fieldtype
		$database->setQuery('SELECT ft_id FROM `#__mt_fieldtypes` WHERE field_type = \'enhancedText\' LIMIT 1;');
		$database->execute();
		if( $database->getNumRows() == 0 ) {
			$database->setQuery('INSERT INTO #__mt_fieldtypes VALUES("", "enhancedText", "Enhanced Text", "class mFieldType_enhancedText extends mFieldType {\r\n	function getOutput($view=1) {\r\n		global $mtconf;\r\n\r\n		$params[\'maxSummaryChars\'] 	= intval($this->getParam(\'maxSummaryChars\',55));\r\n		$params[\'maxDetailsChars\'] 	= intval($this->getParam(\'maxDetailsChars\',0));\r\n		$params[\'parseUrl\'] 		= intval($this->getParam(\'parseUrl\',1));\r\n\r\n		$value = $this->getValue();\r\n		$output = \'\';\r\n		if ( $mtconf->get(\'major_version\') == 2 AND $mtconf->get(\'minor_version\')== 0 ) {\r\n			// @TODO Remove this conditional block when Mosets Tree 2.1 is released as stable.\r\n			if($view == 1 AND $params[\'maxDetailsChars\'] > 0 AND $this->strlen_utf8($value) > $params[\'maxDetailsChars\']) {\r\n				$output .= $this->insertBreaks($this->html_cutstr($value,$params[\'maxDetailsChars\']),$view);\r\n				$output .= \'...\';\r\n			} elseif($view == 2 AND $params[\'maxSummaryChars\'] > 0 AND $this->strlen_utf8($value) > $params[\'maxSummaryChars\']) {\r\n				$output .= $this->insertBreaks($this->html_cutstr($value,$params[\'maxSummaryChars\']),$view);\r\n				$output .= \'...\';\r\n			} else {\r\n				$output = $this->insertBreaks($value,$view);\r\n			}\r\n		} else {\r\n			if($view == 1 AND $params[\'maxDetailsChars\'] > 0 AND JString::strlen($value) > $params[\'maxDetailsChars\']) {\r\n				$output .= $this->insertBreaks(JString::substr($value,$params[\'maxDetailsChars\']),$view);\r\n				$output .= \'...\';\r\n			} elseif($view == 2 AND $params[\'maxSummaryChars\'] > 0 AND JString::strlen($value) > $params[\'maxSummaryChars\']) {							\r\n				$output .= $this->insertBreaks(JString::substr($value,0,$params[\'maxSummaryChars\']),$view);\r\n				$output .= \'...\';\r\n			} else {\r\n				$output = $this->insertBreaks($value,$view);\r\n			}\r\n		}\r\n		\r\n		if($view == 1 AND $params[\'parseUrl\']) {\r\n			$regex = \'/http:\\\\/\\\\/(.*?)(\\\\s|$)/i\';\r\n			$output = preg_replace_callback( $regex, array($this,\'linkcreator\'), $output );\r\n		}\r\n		\r\n		return $output;\r\n	}\r\n	function insertBreaks($text,$view) {\r\n		$params[\'preserveNewline\'] = $this->getParam(\'preserveNewline\',1);\r\n		switch($params[\'preserveNewline\']) {\r\n			case 1:\r\n				if($view == 1) {\r\n					$text = nl2br($text);\r\n				}\r\n				break;\r\n			case 2:\r\n				if($view == 2) {\r\n					$text = nl2br($text);\r\n				}\r\n				break;\r\n			case 3:\r\n				$text = nl2br($text);\r\n				break;\r\n			default:\r\n				$text = nl2br($text);\r\n		}\r\n		return $text;\r\n	}\r\n	function getInputHTML() {\r\n		$params[\'inputType\'] = $this->getParam(\'inputType\',1);\r\n		$params[\'cols\'] = $this->getParam(\'cols\',50);\r\n		switch($params[\'inputType\']) {\r\n			case 2:\r\n				$html = \'<textarea name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" class=\"inputbox text_area\" cols=\"\' . $params[\'cols\'] . \'\" rows=\"\';\r\n				if($this->size < 2) {\r\n					$html .= 2;\r\n				} else {\r\n					$html .= $this->getSize();\r\n				}\r\n				$html .= \'\">\' . $this->getValue() . \'</textarea>\';\r\n				break;\r\n			default:\r\n				$html = \'<input class=\"inputbox text_area\" type=\"text\" name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" size=\"\' . $this->getSize() . \'\" value=\"\' . htmlspecialchars($this->getValue()) . \'\" />\';\r\n				break;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n}", 1, 0, 0, 0, 0);');
			$database->execute();
			$ft_id = $database->insertid();
			
			// Insert enhancedText fieldtype info
			$database->setQuery('INSERT INTO #__mt_fieldtypes_info VALUES("'.$ft_id.'", "6", "http://www.mosets.com", "A field type based on corename with enhanced features. Parameter to specify the maximum number of characters to display in summary and details view. Ability to use single or multi-line textbox and option to display line breaks for newlines.");');
			$database->execute();

			// Update enhancedText params.xml
			$database->setQuery("INSERT INTO #__mt_fieldtypes_att VALUES('', '".$ft_id."', 'params.xml', 0x3c6d6f73706172616d7320747970653d226d6f64756c65223e0a093c706172616d7320616464706174683d222f61646d696e6973747261746f722f636f6d706f6e656e74732f636f6d5f6d747265652f656c656d656e7473223e09090a09093c706172616d206e616d653d22696d616765732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d6167657322206465736372697074696f6e3d22456e746572207468652055524c73206f6620696d6167657320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2055524c73206d75737420626520736570617261746564206279207c2e20596f752063616e20757365207b6c6976655f736974657d20617320746865207265706c6163656d656e7420666f72207468652076616c7565206f66206d6f73436f6e6669675f6c6976655f736974652e2069653a207b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f7a69702e706e677c7b6c6976655f736974657d2f6d656469612f6d656469612f696d616765732f6d696d652d69636f6e2d33322f6d70332e706e67222f3e0a09093c706172616d206e616d653d2273686f77496d616765732220747970653d226c697374222064656661756c743d223122206c6162656c3d2253686f7720496d6167657322206465736372697074696f6e3d22576865726520746f20646973706c61792074686520696d616765732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e2066726f6e742d656e643c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22696d616765416c69676e6d656e742220747970653d226c697374222064656661756c743d22726967687422206c6162656c3d22496d61676520416c69676e6d656e7422206465736372697074696f6e3d2253656c65637420776865726520616e20696d6167652077696c6c20626520646973706c617965642072656c617469766520746865206120636865636b626f782e223e0a0909093c6f7074696f6e2076616c75653d227269676874223e52696768743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d22746f70223e546f703c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226c656674223e4c6566743c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d227374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22435353205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20696d616765732e2042792064656661756c742c20697420697320656d7074792e2069653a20706f736974696f6e3a72656c61746976653b746f703a3470783b6c6566743a3270783b222f3e0a09093c706172616d206e616d653d22636865636b626f785374796c652220747970653d2274657874222073697a653d223434222064656661756c743d2222206c6162656c3d22436865636b626f78205374796c6522206465736372697074696f6e3d225374796c6520746f206265206170706c69656420746f20636865636b626f7865732e2042792064656661756c742c20697420697320656d7074792e2065673a20706f736974696f6e3a72656c61746976653b6c6566743a2d3270783b222f3e0a09093c706172616d206e616d653d2263617074696f6e732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d2243617074696f6e7322206465736372697074696f6e3d2243617074696f6e732061726520646973706c6179206265736964652074686520696d61676520746f2070726f7669646520612073686f7274206465736372697074696f6e206f66206561636820636865636b626f782e20456e746572207468652063617074696f6e7320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e2043617074696f6e73206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2275736543617074696f6e732220747970653d226c697374222064656661756c743d223022206c6162656c3d2253686f772043617074696f6e7322206465736372697074696f6e3d22546f67676c652074686520646973706c6179206f662063617074696f6e732e223e0a0909093c6f7074696f6e2076616c75653d2230223e4e6f3c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2231223e5965733c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e4f6e6c7920696e20456469742073637265656e3c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22616c74732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d61676520414c54732061747472696275746522206465736372697074696f6e3d22414c5473206174747269627574652061726520696e636c7564656420696e20796f757220696d61676520666f72206163636573736962696c69747920616e6420616c6c6f772075736572206167656e747320746861742063616e6e6f7420646973706c617920696d6167657320746f20757365207468697320617320616c7465726e6174656520746578742e204b6565702069742073686f727420616e6420707265636973652e20496620796f75206c65617665207468697320656d7074792c206669656c6420656c656d656e74732077696c6c206265207573656420666f7220746869732e20456e7465722074686520414c5420746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e20414c54207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d227469746c65732220747970653d227069706564746578742220636f6c733d2234302220726f77733d2236222064656661756c743d2222206c6162656c3d22496d616765205449544c45732061747472696275746522206465736372697074696f6e3d22546869732077696c6c20626520616464656420746f20796f757220696d61676573206173205469746c65206174747269627574652e20557365207468697320746f2070726f76696465206164646974696f6e616c20696e666f726d6174696f6e20746f2065616368206f6620796f757220696d616765732e204d6f73742062726f777365727320646973706c6179207469746c652074657874206173206120746f6f6c746970207768656e20697420697320686f7665726564206f7665722e20456e74657220746865205449544c4520746578747320636f72726573706f6e64696e6720746f2074686520656c656d656e747320646566696e656420666f72207468697320637573746f6d206669656c642e205449544c45207465787473206d75737420626520736570617261746564206279207c2e222f3e0a09093c706172616d206e616d653d2264764f75747075742220747970653d226c697374222064656661756c743d226822206c6162656c3d2244657461696c7320766965772773206f7574707574223e0a0909093c6f7074696f6e2076616c75653d22756c223e556e6f726465726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d226f6c223e4e756d6265726564204c6973743c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2268223e486f72697a6f6e74616c6c793c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2276223e566572746963616c6c793c2f6f7074696f6e3e0a09093c2f706172616d3e0a09093c706172616d206e616d653d22636f6c756d6e732220747970653d226c697374222064656661756c743d223122206c6162656c3d22436f6c756d6e7322206465736372697074696f6e3d22456e74657220746865206e756d626572206f6620636f6c756d6e732e223e0a0909093c6f7074696f6e2076616c75653d2231223e313c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2232223e323c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2233223e333c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2234223e343c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2235223e353c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2236223e363c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2237223e373c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2238223e383c2f6f7074696f6e3e0a0909093c6f7074696f6e2076616c75653d2239223e393c2f6f7074696f6e3e0a09093c2f706172616d3e0a093c2f706172616d733e0a3c2f6d6f73706172616d733e, 3544, 'text/xml', 1);");
			$database->execute();			
			$this->printStatus( 'Added enhancedText field type.' );
		} else {
			$ft_id = $database->loadResult();
			
			// Update enhancedText class code
			$database->setQuery('UPDATE #__mt_fieldtypes SET ft_class = "class mFieldType_enhancedText extends mFieldType {\r\n	function getOutput($view=1) {\r\n		global $mtconf;\r\n\r\n		$params[\'maxSummaryChars\'] 	= intval($this->getParam(\'maxSummaryChars\',55));\r\n		$params[\'maxDetailsChars\'] 	= intval($this->getParam(\'maxDetailsChars\',0));\r\n		$params[\'parseUrl\'] 		= intval($this->getParam(\'parseUrl\',1));\r\n\r\n		$value = $this->getValue();\r\n		$output = \'\';\r\n		if ( $mtconf->get(\'major_version\') == 2 AND $mtconf->get(\'minor_version\')== 0 ) {\r\n			// @TODO Remove this conditional block when Mosets Tree 2.1 is released as stable.\r\n			if($view == 1 AND $params[\'maxDetailsChars\'] > 0 AND $this->strlen_utf8($value) > $params[\'maxDetailsChars\']) {\r\n				$output .= $this->insertBreaks($this->html_cutstr($value,$params[\'maxDetailsChars\']),$view);\r\n				$output .= \'...\';\r\n			} elseif($view == 2 AND $params[\'maxSummaryChars\'] > 0 AND $this->strlen_utf8($value) > $params[\'maxSummaryChars\']) {\r\n				$output .= $this->insertBreaks($this->html_cutstr($value,$params[\'maxSummaryChars\']),$view);\r\n				$output .= \'...\';\r\n			} else {\r\n				$output = $this->insertBreaks($value,$view);\r\n			}\r\n		} else {\r\n			if($view == 1 AND $params[\'maxDetailsChars\'] > 0 AND JString::strlen($value) > $params[\'maxDetailsChars\']) {\r\n				$output .= $this->insertBreaks(JString::substr($value,$params[\'maxDetailsChars\']),$view);\r\n				$output .= \'...\';\r\n			} elseif($view == 2 AND $params[\'maxSummaryChars\'] > 0 AND JString::strlen($value) > $params[\'maxSummaryChars\']) {							\r\n				$output .= $this->insertBreaks(JString::substr($value,0,$params[\'maxSummaryChars\']),$view);\r\n				$output .= \'...\';\r\n			} else {\r\n				$output = $this->insertBreaks($value,$view);\r\n			}\r\n		}\r\n		\r\n		if($view == 1 AND $params[\'parseUrl\']) {\r\n			$regex = \'/http:\\\\/\\\\/(.*?)(\\\\s|$)/i\';\r\n			$output = preg_replace_callback( $regex, array($this,\'linkcreator\'), $output );\r\n		}\r\n		\r\n		return $output;\r\n	}\r\n	function insertBreaks($text,$view) {\r\n		$params[\'preserveNewline\'] = $this->getParam(\'preserveNewline\',1);\r\n		switch($params[\'preserveNewline\']) {\r\n			case 1:\r\n				if($view == 1) {\r\n					$text = nl2br($text);\r\n				}\r\n				break;\r\n			case 2:\r\n				if($view == 2) {\r\n					$text = nl2br($text);\r\n				}\r\n				break;\r\n			case 3:\r\n				$text = nl2br($text);\r\n				break;\r\n			default:\r\n				$text = nl2br($text);\r\n		}\r\n		return $text;\r\n	}\r\n	function getInputHTML() {\r\n		$params[\'inputType\'] = $this->getParam(\'inputType\',1);\r\n		$params[\'cols\'] = $this->getParam(\'cols\',50);\r\n		switch($params[\'inputType\']) {\r\n			case 2:\r\n				$html = \'<textarea name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" class=\"inputbox text_area\" cols=\"\' . $params[\'cols\'] . \'\" rows=\"\';\r\n				if($this->size < 2) {\r\n					$html .= 2;\r\n				} else {\r\n					$html .= $this->getSize();\r\n				}\r\n				$html .= \'\">\' . $this->getValue() . \'</textarea>\';\r\n				break;\r\n			default:\r\n				$html = \'<input class=\"inputbox text_area\" type=\"text\" name=\"\' . $this->getInputFieldName(1) . \'\" id=\"\' . $this->getInputFieldName(1) . \'\" size=\"\' . $this->getSize() . \'\" value=\"\' . htmlspecialchars($this->getValue()) . \'\" />\';\r\n				break;\r\n		}\r\n		return $html;\r\n	}\r\n	\r\n}"  WHERE field_type = "enhancedText" LIMIT 1');
			$database->execute();

			// Update enhancedText version number
			$database->setQuery('UPDATE #__mt_fieldtypes_info SET ft_version = "6" WHERE ft_id = "59" LIMIT 1');
			$database->execute();

			// Update enhancedText params.xml
			$database->setQuery("UPDATE #__mt_fieldtypes_att SET filedata = 0x3C6D6F73706172616D7320747970653D226D6F64756C65223E0A093C706172616D733E0A09093C706172616D206E616D653D226D617853756D6D61727943686172732220747970653D2274657874222064656661756C743D22353522206C6162656C3D224D61782E206368617261637465727320696E2053756D6D61727920766965772E22206465736372697074696F6E3D22456E746572203020746F2073686F77207468652066756C6C2074657874207265676172646C657373206F6620697473206C656E6774682E22202F3E0A09093C706172616D206E616D653D226D617844657461696C7343686172732220747970653D2274657874222064656661756C743D223022206C6162656C3D224D61782E206368617261637465727320696E2044657461696C7320766965772E22206465736372697074696F6E3D22456E746572203020746F2073686F77207468652066756C6C2074657874207265676172646C657373206F6620697473206C656E6774682E22202F3E0A09093C706172616D206E616D653D22696E707574547970652220747970653D226C697374222064656661756C743D223122206C6162656C3D22496E707574207479706522206465736372697074696F6E3D22466F7220626F74682053696E676C6520616E64204D756C74692D6C696E65207465787420626F782C207468652073697A65206F7074696F6E206973207573656420746F20636F6E74726F6C2074686520776964746820616E6420686569676874206F662074686520726573706563746976652074657874626F782E223E0A0909093C6F7074696F6E2076616C75653D2231223E53696E676C652D6C696E652054657874626F783C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2232223E4D756C74692D6C696E652054657874626F783C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22636F6C732220747970653D226C697374222064656661756C743D22353022206C6162656C3D22436F6C756D6E7322206465736372697074696F6E3D22436F6C756D6E732073706563696679207468652077696474682028696E20636F6C756D6E7329206F66206D756C74692D6C696E652074657874626F7820696620746869732069732073656C65637465642061626F76652E223E0A0909093C6F7074696F6E2076616C75653D2235223E353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223130223E31303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223135223E31353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223230223E32303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223235223E32353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223330223E33303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223335223E33353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223430223E34303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223435223E34353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223530223E35303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223535223E35353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223630223E36303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223635223E36353C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223730223E37303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223830223E38303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D223930223E39303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D22313030223E3130303C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D22313230223E3132303C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D2270726573657276654E65776C696E652220747970653D226C697374222064656661756C743D223122206C6162656C3D225072657365727665206E65776C696E6522206465736372697074696F6E3D22496620796F75277265207573696E672061204D756C74692D6C696E652074657874626F782C2074686973206F7074696F6E20616C6C6F7720796F7520746F20636F6E74726F6C20776865726520746F20707265736572766520746865206E65776C696E6520696E207468652074657874207468617420697320656E74657265642E223E0A0909093C6F7074696F6E2076616C75653D2231223E44657461696C732076696577206F6E6C793C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2232223E53756D6D6172792076696577206F6E6C793C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2233223E44657461696C7320616E642053756D6D6172792020766965773C2F6F7074696F6E3E0A09093C2F706172616D3E0A09093C706172616D206E616D653D22706172736555726C2220747970653D22726164696F222064656661756C743D223122206C6162656C3D2250617273652055524C206173206C696E6B20696E2044657461696C732076696577223E0A0909093C6F7074696F6E2076616C75653D2230223E4E6F3C2F6F7074696F6E3E0A0909093C6F7074696F6E2076616C75653D2231223E5965733C2F6F7074696F6E3E0A09093C2F706172616D3E0A093C2F706172616D733E0A3C2F6D6F73706172616D733E, filesize = 2068 WHERE ft_id = 59 AND filename = 'params.xml' LIMIT 1");
			$database->execute();
			$this->printStatus( 'Updated enhancedText field type to version 6.' );
		}
		
		updateVersion(2,2,0);
		$this->updated = true;
		return true;
	}
}
?>